---
import Button from "./Button.astro";
import Dialog from "./Dialog.astro";
import Input from "./Input.astro";
---

<Button
  label="Avísame"
  variant="default"
  class="animate-fade-in-up animate-delay-1000 animate-duration-1000"
  data-open-dialog="avisame"
/>

 <Dialog title="¡No te pierdas la apertura!" id="avisame" showSubmit={false}>
  <form id="avisame-form" action="https://formspree.io/f/maqqqezd" method="POST" class="flex flex-col gap-4">
    <p class="text-sm text-gray-600">
      Déjanos tu email y te avisaremos para la inauguración de la nueva Clínica Dental Teresa Molés, Espacio de Bienestar.
    </p>

    <Input
      label="Nombre"
      placeholder="Tu nombre completo"
      name="name"
      required
    />

    <Input
      label="Email"
      type="email"
      placeholder="tu@email.com"
      name="_replyto"
      required
    />

    <div class="flex flex-col gap-0">
      <label class="flex items-center gap-2 text-sm cursor-pointer">
        <input
          type="checkbox"
          class="w-4 h-4 accent-[var(--color-primary)] cursor-pointer"
          required
          name="privacy"
        />
        <span class="text-left">He leído y acepto la política de privacidad</span>
      </label>
      <p class="text-tiny text-left"><strong>Responsable:</strong> Teresa Molés SL. <strong>Finalidad:</strong> Enviarle información sobre la apertura de nuestra clínica y bienestar. <strong>Legitimación:</strong> Consentimiento del interesado. <strong>Destinatarios:</strong> No se cederán datos a terceros, salvo obligación legal. <strong>Derechos:</strong> Tiene derecho a acceder, rectificar y suprimir los datos, así como otros derechos, como se explica en la información adicional. <strong>Información adicional:</strong> Puede consultar la información adicional y detallada sobre Protección de Datos Personales en el Aviso Legal y Política de Privacidad.</p>
    </div>

    <label class="flex items-center gap-2 text-sm cursor-pointer">
      <input
        type="checkbox"
        class="w-4 h-4 accent-[var(--color-primary)] cursor-pointer"
        required
        name="newsletter"
      />
      <span class="text-left">Acepto el envío de emails</span>
    </label>

    <div class="flex justify-center mt-6">
      <Button
        label="Enviar"
        id="submit-btn"
        type="submit"
      />
    </div>
  </form>
</Dialog>

<script>
  function isValidEmail(email) {
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return emailRegex.test(email);
  }

  function checkFormValidity(form, submitBtn) {
    const requiredInputs = form.querySelectorAll('input[required], textarea[required]');
    const requiredCheckboxes = form.querySelectorAll('input[type="checkbox"][required]');

    let allValid = true;

    requiredInputs.forEach(input => {
      if (input.type === 'email') {
        if (!input.value.trim() || !isValidEmail(input.value)) {
          allValid = false;
        }
      } else {
        if (!input.value.trim()) {
          allValid = false;
        }
      }
    });

    requiredCheckboxes.forEach(checkbox => {
      if (!checkbox.checked) {
        allValid = false;
      }
    });

    submitBtn.disabled = !allValid;
    submitBtn.style.opacity = allValid ? '1' : '0.5';
  }

  document.addEventListener("DOMContentLoaded", () => {
    // Handle avisame form
    const avisameDialog = document.querySelector('[data-dialog="avisame"]');
    if (avisameDialog) {
      const form = avisameDialog.querySelector('form');
      const submitBtn = avisameDialog.querySelector('#submit-btn');
      const emailInput = form.querySelector('input[type="email"]');

      if (form && submitBtn) {
        // Initial check
        checkFormValidity(form, submitBtn);

        // Listen for changes
        form.addEventListener('input', () => checkFormValidity(form, submitBtn));
        form.addEventListener('change', () => checkFormValidity(form, submitBtn));

        // Handle form submission
        form.addEventListener('submit', async (e) => {
          e.preventDefault();
          if (!submitBtn.disabled) {
            const formData = new FormData(form);
            try {
              const response = await fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: {
                  'Accept': 'application/json'
                }
              });
              if (response.ok) {
                alert('Suscripción registrada. Te avisaremos cuando abramos.');
                form.reset();
                avisameDialog.classList.add('hidden');
              } else {
                alert('Error al registrar la suscripción. Inténtalo de nuevo.');
              }
            } catch (error) {
              alert('Error al registrar la suscripción. Inténtalo de nuevo.');
            }
          }
        });

        // Email validation on blur
        if (emailInput) {
          const inputContainer = emailInput.parentElement;
          let errorSpan = inputContainer.querySelector('.email-error');

          emailInput.addEventListener('blur', () => {
            if (emailInput.value && !isValidEmail(emailInput.value)) {
              emailInput.style.borderColor = 'var(--color-secondary)';
              emailInput.style.borderWidth = '1px';
              if (!errorSpan) {
                errorSpan = document.createElement('span');
                errorSpan.className = 'email-error text-xs text-left text-[var(--color-secondary)]';
                errorSpan.textContent = 'Email incorrecto';
                inputContainer.appendChild(errorSpan);
              }
            } else {
              emailInput.style.borderColor = '';
              emailInput.style.borderWidth = '';
              if (errorSpan) {
                errorSpan.remove();
                errorSpan = null;
              }
            }
          });

          emailInput.addEventListener('input', () => {
            if (isValidEmail(emailInput.value)) {
              emailInput.style.borderColor = '';
              emailInput.style.borderWidth = '';
              if (errorSpan) {
                errorSpan.remove();
                errorSpan = null;
              }
            }
          });
        }
      }
    }
  });
</script>
<!-- Dialog de confirmación -->
<Dialog title="¡Hasta Pronto!" id="avisame-success" showSubmit={false}>
  <p>¡Te has inscrito correctamente! Pronto recibirás un email con toda la información sobre la apertura.</p>
  <div class="flex justify-center mt-6">
    <Button label="Cerrar" id="avisame-success-close" type="button" />
  </div>
</Dialog>

<script type="module">
  const avisameDialog = document.querySelector('[data-dialog="avisame"]');
  const successDialog = document.querySelector('[data-dialog="avisame-success"]');
  const form = document.getElementById('avisame-form');
  const submitBtn = form.querySelector('#submit-btn');
  const closeSuccessBtn = successDialog.querySelector('#avisame-success-close');

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    submitBtn.disabled = true;
    submitBtn.textContent = 'Enviando...';

    const formData = new FormData(form);

    try {
      const res = await fetch(form.action, {
        method: form.method,
        body: formData,
        headers: { 'Accept': 'application/json' }
      });

      if (res.ok) {
        form.reset();
        avisameDialog.classList.add('hidden'); // cerrar formulario
        successDialog.classList.remove('hidden'); // abrir dialog de éxito
      } else {
        alert('Hubo un error al enviar el formulario.');
      }
    } catch {
      alert('Hubo un error al enviar el formulario.');
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = 'Enviar';
    }
  });

  closeSuccessBtn.addEventListener('click', () => {
    successDialog.classList.add('hidden');
  });
</script>