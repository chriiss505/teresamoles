---
import Dialog from '../../components/Dialog.astro';
import Input from '../../components/Input.astro';
import Textarea from '../../components/Textarea.astro';
import Button from '../../components/Button.astro';
import Badge from '../../components/Badge.astro';

---
<header class="animate-fade-in-down animate-delay-300 animate-duration-1000 sticky top-0 z-50 w-full py-4 sm:py-6 backdrop-blur-sm bg-[var(--color-background)]/80">
  <nav class="flex items-center justify-center sm:justify-between max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">        {/* Contenido izquierda */}
        <div class="hidden sm:flex items-center">
            <button onclick="window.location.reload()" class="text-lg sm:text-xl bg-transparent border-none cursor-pointer">( )</button>
        </div>

        {/* Contenido derecha */}
        <div class="flex items-center">
            <div class="button-group flex items-center justify-center gap-0">
                <button
                    data-open-dialog="info"
                    class="button-group__item button-group__item--first shadow-sm"
                >
                    Información
                </button>
                <button
                    data-open-dialog="contact"
                    class="button-group__item button-group__item--last shadow-sm"
                >
                    Contáctanos
                </button>
            </div>
        </div>

</nav>
 
</header>
<!-- Dialogs -->
<Dialog title="Información" id="info" showSubmit={false}>
    <h4>El espacio</h4>
    <p>Estamos trabajando para construir un espacio donde te sientas bien. Queremos ser tu Clínica Dental de confianza en Burriana y espacio de referencia en el bienestar.</p>
    <p>Nos encontramos en: <a href="https://www.google.com/maps/search/?api=1&query=Avenida+Cardenal+Vicente+Enrique+Tarancón+22,+Burriana" target="_blank" rel="noopener noreferrer" class="underline flex items-center gap-1" style="color: var(--color-primary);">Avenida Cardenal Vicente Enrique Tarancón 22 <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></a></p>
    <h4>Teresa Molés</h4>
    <p>Natural de Burriana, después de más de 10 años de experiencia en diferentes clínicas, ha decidido poner en marcha la suya propia. Su objetivo es tratar a las personas con profesionalidad, respeto y humanidad.</p>
</Dialog>

<Dialog title="¿Quieres decirnos algo?" id="contact">
    <p>Utiliza este formulario para contactar con nosotras/el equipo Teresa Molés y te responderemos lo antes posible.</p>
    <form id="contact-form" action="https://formspree.io/f/mnjjjpyd" method="POST" class="flex flex-col gap-4">
        <Input
            label="Nombre"
            placeholder="Tu nombre completo"
            name="name"
            required
        />

        <Input
            label="Email"
            type="email"
            placeholder="tu@email.com"
            name="_replyto"
            required
        />

        <Textarea
            label="Mensaje"
            placeholder="Escribe tu mensaje aquí..."
            name="message"
            required
        />

        <div class="flex flex-col gap-0">
            <label class="flex items-center gap-2 text-sm cursor-pointer">
                <input
                    type="checkbox"
                    class="w-4 h-4 accent-[var(--color-primary)] cursor-pointer"
                    required
                    name="privacy"
                />
                <span class="text-left">He leído y acepto la política de privacidad</span>
            </label>
            <p class="text-tiny text-left"><strong>Responsable:</strong> Teresa Molés SL. <strong>Finalidad:</strong> Dar respuesta a las consultas a través del formulario de contacto. <strong>Legitimación:</strong> Consentimiento del interesado. <strong>Destinatarios:</strong> No se cederán datos a terceros, salvo obligación legal. <strong>Derechos:</strong> Tiene derecho a acceder, rectificar y suprimir los datos, así como otros derechos, como se explica en la información adicional. <strong>Información adicional:</strong> Puede consultar la información adicional y detallada sobre Protección de Datos Personales en el Aviso Legal y Política de Privacidad.</p>
        </div>

        <div class="flex justify-center mt-6">
          <Button
            label="Enviar"
            id="submit-btn"
            type="submit"
          />
        </div>
     </form>
</Dialog>

<style>
  .button-group__item {
    background-color: #e7e6e6;
    color: var(--color-foreground);
    font-size: 0.8rem;
    font-weight: 400;
    padding: 0.400rem 1rem;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: opacity 0.2s ease-in-out;
    white-space: nowrap;
    text-decoration: none;
    border: solid 1px #e9e9e9;
  }

  .button-group__item:hover {
    opacity: 0.85;
  }

  .button-group__item--first {
    border-top-left-radius: 9999px;
    border-bottom-left-radius: 9999px;
  }

  .button-group__item--last {
    border-top-right-radius: 9999px;
    border-bottom-right-radius: 9999px;
  }

  @media (min-width: 640px) {
    .button-group__item {
      font-size: 1rem;
      padding: 0.4rem 1.5rem;
    }
  }
</style>

<script>
  function initDialogs() {
    const dialogs = document.querySelectorAll("[data-dialog]");
    const openBtns = document.querySelectorAll("[data-open-dialog]");
    const closeButtons = document.querySelectorAll("[data-close-dialog]");

    openBtns.forEach(btn => {
      const dialogId = btn.dataset.openDialog;
      const dialog = document.querySelector(`[data-dialog="${dialogId}"]`);
      if (dialog) {
        btn.addEventListener("click", () => {
          dialog.classList.remove("hidden");
        });
      }
    });

    closeButtons.forEach(btn => {
      btn.addEventListener("click", (e) => {
        e.preventDefault();
        const dialog = btn.closest("[data-dialog]");
        if (dialog) {
          dialog.classList.add("hidden");
        }
      });
    });
  }

  function isValidEmail(email) {
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return emailRegex.test(email);
  }

  function checkFormValidity(form, submitBtn) {
    const requiredInputs = form.querySelectorAll('input[required], textarea[required]');
    const requiredCheckboxes = form.querySelectorAll('input[type="checkbox"][required]');

    let allValid = true;

    requiredInputs.forEach(input => {
      if (input.type === 'email') {
        if (!input.value.trim() || !isValidEmail(input.value)) {
          allValid = false;
        }
      } else {
        if (!input.value.trim()) {
          allValid = false;
        }
      }
    });

    requiredCheckboxes.forEach(checkbox => {
      if (!checkbox.checked) {
        allValid = false;
      }
    });

    submitBtn.disabled = !allValid;
    submitBtn.style.opacity = allValid ? '1' : '0.5';
  }

  document.addEventListener("DOMContentLoaded", () => {
    initDialogs();

    // Handle contact form
    const contactDialog = document.querySelector('[data-dialog="contact"]');
    if (contactDialog) {
      const form = contactDialog.querySelector('form');
      const submitBtn = contactDialog.querySelector('#submit-btn');
      const emailInput = form.querySelector('input[type="email"]');

      if (form && submitBtn) {
        // Initial check
        checkFormValidity(form, submitBtn);

        // Listen for changes
        form.addEventListener('input', () => checkFormValidity(form, submitBtn));
        form.addEventListener('change', () => checkFormValidity(form, submitBtn));

        // Email validation on blur
        if (emailInput) {
          const inputContainer = emailInput.parentElement;
          let errorSpan = inputContainer.querySelector('.email-error');

          emailInput.addEventListener('blur', () => {
            if (emailInput.value && !isValidEmail(emailInput.value)) {
              emailInput.style.borderColor = 'var(--color-secondary)';
              emailInput.style.borderWidth = '1px';
              if (!errorSpan) {
                errorSpan = document.createElement('span');
                errorSpan.className = 'email-error text-xs text-left text-[var(--color-secondary)]';
                errorSpan.textContent = 'Email incorrecto';
                inputContainer.appendChild(errorSpan);
              }
            } else {
              emailInput.style.borderColor = '';
              emailInput.style.borderWidth = '';
              if (errorSpan) {
                errorSpan.remove();
                errorSpan = null;
              }
            }
          });

          emailInput.addEventListener('input', () => {
            if (isValidEmail(emailInput.value)) {
              emailInput.style.borderColor = '';
              emailInput.style.borderWidth = '';
              if (errorSpan) {
                errorSpan.remove();
                errorSpan = null;
              }
            }
          });
        }
      }
    }

    // Handle cookie config dialog
    const configDialog = document.querySelector('[data-dialog="cookie-config"]');
    if (configDialog) {
      const saveBtn = configDialog.querySelector('#save-cookie-config');
      const acceptAllBtn = configDialog.querySelector('#accept-all-config');
      const acceptEssentialBtn = configDialog.querySelector('#accept-essential-config');
      const analyticsCheckbox = configDialog.querySelector('#analytics-cookies');

      // Load current consent when dialog opens
      const openConfigBtns = document.querySelectorAll('[data-open-dialog="cookie-config"]');
      openConfigBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          const consent = JSON.parse(localStorage.getItem("cookieConsent") || '{}');
          analyticsCheckbox.checked = consent.analytics || false;
        });
      });

      saveBtn.addEventListener('click', () => {
        const consent = {
          necessary: true,
          analytics: analyticsCheckbox.checked
        };
        localStorage.setItem("cookieConsent", JSON.stringify(consent));
        configDialog.classList.add("hidden");
        // Hide banner if exists
        const banner = document.getElementById("cookie-banner");
        if (banner) banner.classList.add("hidden");
      });

      acceptAllBtn.addEventListener('click', () => {
        const consent = {
          necessary: true,
          analytics: true
        };
        localStorage.setItem("cookieConsent", JSON.stringify(consent));
        configDialog.classList.add("hidden");
        const banner = document.getElementById("cookie-banner");
        if (banner) banner.classList.add("hidden");
      });

      acceptEssentialBtn.addEventListener('click', () => {
        const consent = {
          necessary: true,
          analytics: false,
          marketing: false
        };
        localStorage.setItem("cookieConsent", JSON.stringify(consent));
        configDialog.classList.add("hidden");
        const banner = document.getElementById("cookie-banner");
        if (banner) banner.classList.add("hidden");
      });
    }
  });
</script>
<!-- Dialog de confirmación -->
<Dialog title="¡Gracias!" id="contact-success" showSubmit={false}>
  <p>¡Mensaje enviado correctamente! Te responderemos lo antes posible.</p>
  <div class="flex justify-center mt-6">
    <Button label="Cerrar" id="success-close" type="button" />
  </div>
</Dialog>

<script type="module">
  const contactDialog = document.querySelector('[data-dialog="contact"]');
  const successDialog = document.querySelector('[data-dialog="contact-success"]');
  const form = contactDialog.querySelector('form');
  const submitBtn = contactDialog.querySelector('#submit-btn');
  const closeSuccessBtn = successDialog.querySelector('#success-close');

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    submitBtn.disabled = true;
    submitBtn.textContent = 'Enviando...';

    const formData = new FormData(form);

    try {
      const res = await fetch(form.action, {
        method: form.method,
        body: formData,
        headers: { 'Accept': 'application/json' }
      });

      if (res.ok) {
        form.reset();
        contactDialog.classList.add('hidden'); // cerrar contacto
        successDialog.classList.remove('hidden'); // abrir dialog de éxito
      } else {
        alert('Hubo un error al enviar el mensaje.');
      }
    } catch {
      alert('Hubo un error al enviar el mensaje.');
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = 'Enviar';
    }
  });

  closeSuccessBtn.addEventListener('click', () => {
    successDialog.classList.add('hidden');
  });
</script>
